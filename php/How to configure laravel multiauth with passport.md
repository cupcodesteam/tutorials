# How to configure laravel multiauth with passport

<p>
Laravel facilitates authentication through traditional login forms, but APIs typically use tokens to authenticate users and do not maintain session state between requests, which we call Stateless. In Laravel API authentication is made easier by using Laravel Passport, which provides an OAuth2 implementation.
</p>

<p>
The first step is to install the passport, through the composer.
</p>

'''
composer require laravel/passport
'''

<p>
With the installation done, we need to use the standard registry of laravel in relation to the tables of the database, then just run the migration;
</p>

'''
php artisan migrate
'''

<p>
Next, we should run passport install . This command will create the encryption keys needed to generate secure access tokens. In addition, the command will create "personal access" and "password grant" clients  , which are two methods of generating access tokens that are available in the passport.
</p>

'''
php artisan passport:install
'''

<p>
Then you need to modify the User Model as follows:
</p>

'''
namespace App;

use Laravel\Passport\HasApiTokens;
use Illuminate\Notifications\Notifiable;
use Illuminate\Foundation\Auth\User as Authenticatable;

class User extends Authenticatable
{
    use HasApiTokens, Notifiable;
}
'''

<p>
Next, we must call the Passport routes method within the AuthServiceProvider startup method. This method will log the routes needed to issue access token and revoke access tokens,  clients, and personal access tokens;
</p>

'''
namespace App\Providers;
 
use Laravel\Passport\Passport;
use Illuminate\Support\Facades\Gate;
use Illuminate\Foundation\Support\Providers\AuthServiceProvider as ServiceProvider;
 
class AuthServiceProvider extends ServiceProvider
{
    /**
     * The policy mappings for the application.
     *
     * @var array
     */
    protected $policies = [
        'App\Model' => 'App\Policies\ModelPolicy',
    ];
 
    /**
     * Register any authentication / authorization services.
     *
     * @return void
     */
    public function boot()
    {
        $this->registerPolicies();
 
        Passport::routes();
    }
}
'''

<p>
Finally, in your *config / auth.php* configuration file , you must set the driver authentication option of the API for the passport. This will instruct your application to use Passport's TokenGuard when authenticating requests received from the API:
</p>

'''
<?php

'guards' => [
    'web' => [
        'driver' => 'session',
        'provider' => 'users',
    ],

    'api' => [
        'driver' => 'passport',
        'provider' => 'users',
    ],
]
'''

<p>
This part is extraordinarily important. You must use the passport password to process. It is based on traditional user access generated by laravel itself, composed of a client that is generated with the following command:
</p>

'''
php artisan passport:client --password
'''

<p>
This command will ask for the name of the client that will gain access. I usually choose the password name.
</p>

<p>
Now we just need to make some bugs in the imported classes inside the vendor. Let's go to them!
</p>

1. File: vendor\laravel\passport\src\Bridge\UserRepository.php
- Copy / Paste getUserEntityByUserCredentials to make a duplicate of it and name it getEntityByUserCredentials
- Then, in the new duplicated function, find the below:
'''
$provider = config('auth.guards.api.provider');
'''
- and Replace it with:
'''
$provider = config('auth.guards.'.$theNewProvider.'.provider');
'''
- After that add $theNewProvider to getEntityByUserCredentials arguments as follow:
'''
public function getEntityByUserCredentials($username, $password, $grantType, ClientEntityInterface $clientEntity, $theNewProvider)
'''

2. File: vendor\league\oauth2-server\src\Grant\PasswordGrant.php
- In the function *validateUser* update with the following code:
'''
$user = $this->userRepository->getEntityByUserCredentials(
      $username,
      $password,
      $this->getIdentifier(),
      $client,
      $theNewProvider
'''
- add the following variable to the same function:
'''
$theNewProvider = $this->getRequestParameter('theNewProvider', $request);

 if (is_null($theNewProvider)) {
 throw OAuthServerException::invalidRequest('theNewProvider');
 }
'''

<p>
Now we just need to test. To do this, simply use Postman or any other extension or program that communicates with the REST API using the following POST endpoint.
</p>

'''
http://localhost:8000/oauth/token
'''

### HEADER
'''
Content-Type application/json
'''

### BODY json
'''
{

   "grant_type": "password",
   "client_id": 1,
   "client_secret": "yLz79iFZbJsNNc9SLsv5Ycex68LtlYsRrGR5gN5M",
   "username": "admin@gmail.com",
   "password": "teste123"
}
'''

#### Used fonts:
- https://github.com/laravel/passport/issues/161#issuecomment-299690583
- https://www.pipelinelab.com.br/autenticacao-de-apis-com-passport-laravel/
